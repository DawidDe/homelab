---
- name: Bootstrap Server
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Get vars
      set_fact:
        idrac_ip: "{{ lookup('community.hashi_vault.vault_kv2_get', engine_mount_point='v1/kv', secret_path=name ~ '-infra', secret_key='idrac_ip', url=vault_address, token=vault_token) }}"
        idrac_user: "{{ lookup('community.hashi_vault.vault_kv2_get', engine_mount_point='v1/kv', secret_path=name ~ '-infra', secret_key='idrac_user', url=vault_address, token=vault_token) }}"
        idrac_password: "{{ lookup('community.hashi_vault.vault_kv2_get', engine_mount_point='v1/kv', secret_path=name ~ '-infra', secret_key='idrac_password', url=vault_address, token=vault_token) }}"
    - name: Edit iDRAC User
      dellemc.openmanage.idrac_user:
        idrac_ip: "{{ idrac_ip }}"
        idrac_user: "root"
        idrac_password: "calvin"
        validate_certs: false
        state: "present"
        user_name: "root"
        new_user_name: "{{ idrac_user }}"
        user_password: "{{ idrac_password }}"
    - name: Edit BIOS Settings
      dellemc.openmanage.idrac_bios:
        idrac_ip: "{{ idrac_ip }}"
        idrac_user: "{{ idrac_user }}"
        idrac_password: "{{ idrac_password }}"
        validate_certs: false
        attributes:
          BootMode: "Uefi"
          SecureBoot: "Enabled"
          SecureBootPolicy: "Standard"
          InternalUsb: "Off"
          EmbVideo: "Disabled"
          SetupPassword: "{{ bios_setup_password }}"
          SystemPassword: "{{ bios_system_password }}"
          TpmCommand: "Activate"
          TpmSecurity: "OnPbm"
          SecurityFreezeLock: "Enabled"
          WriteCache: "Disabled"
          WriteCacheCrc: "Disabled"
    - name: Boot Server to ISO
      dellemc.openmanage.idrac_os_deployment:
        idrac_ip: "{{ idrac_ip }}"
        idrac_user: "{{ idrac_user }}"
        idrac_password: "{{ idrac_password }}"
        validate_certs: false
        share_name: "192.168.178.45:/home/dawid/homelab/base/iso"
        iso_image: "proxmox.iso"
        expose_duration: 180