---
- name: Bootstrap Server
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Retrieve Vars
      set_fact:
        secrets: "{{ lookup('hashi_vault', 'secret=kv/data/' ~ name ~ '-infra engine_mount_point=kv token=' ~ vault_token ~ ' url=' ~ vault_address) }}"
    - name: Set Facts
      set_fact:
        idrac_ip: "{{ secrets.idrac_ip }}"
        idrac_user: "{{ secrets.idrac_user }}"
        idrac_password: "{{ secrets.idrac_password }}"
        bios_password: "{{ secrets.bios_password }}"
    - name: Edit iDRAC User
      dellemc.openmanage.idrac_user:
        idrac_ip: "{{ idrac_ip }}"
        idrac_user: "root"
        idrac_password: "calvin"
        validate_certs: false
        state: "present"
        user_name: "root"
        new_user_name: "{{ idrac_user }}"
        user_password: "{{ idrac_password }}"
    - name: Edit BIOS Settings
      dellemc.openmanage.idrac_bios:
        idrac_ip: "{{ idrac_ip }}"
        idrac_user: "{{ idrac_user }}"
        idrac_password: "{{ idrac_password }}"
        validate_certs: false
        attributes:
          BootMode: "Uefi"
          SecureBoot: "Enabled"
          SecureBootPolicy: "Standard"
          InternalUsb: "Off"
          EmbVideo: "Disabled"
          SetupPassword: "{{ bios_password }}"
          TpmCommand: "Activate"
          TpmSecurity: "OnPbm"
          SecurityFreezeLock: "Enabled"
          WriteCache: "Disabled"
          WriteCacheCrc: "Disabled"